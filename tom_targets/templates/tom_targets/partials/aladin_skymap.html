<!-- embedding Aladin Lite example code found at: https://aladin.cds.unistra.fr/AladinLite/doc/  -->
{% load bootstrap4 tom_common_extras %}
<div id="aladin-target-warning" class="d-none mt-2">
{% bootstrap_alert "Map display will be limited to 10,000 randomly sampled targets" alert_type="warning" %}
</div>
<div id="aladin-lite-div" style="width:auto; height:450px; margin:auto; margin-top: 10px;" ></div>
<script type="text/javascript">
async function fetchAladinTargets() {
  const url = "{% url 'tom_targets:aladin' %}{% querystring %}".replace("&amp;", "&");
  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error("Failed to fetch Aladin targets");
    }

    const jsonTargets = await response.json();
    return jsonTargets.targets;
  } catch (error) {
    console.error(error);
  }
}

(async function loadAladin() {
    const scriptKey = "cachedAladinJS";

    if (sessionStorage.getItem(scriptKey)) {
        // Load script from sessionStorage
        const scriptContent = sessionStorage.getItem(scriptKey);
        const script = document.createElement("script");
        script.type = "text/javascript";
        script.text = scriptContent;
        document.head.appendChild(script);
        console.log("Loaded aladin.js from sessionStorage");
    } else {
        // Fetch and cache the script
        console.log("Fetching aladin.js ...");
        const response = await fetch("https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.js");
        const scriptText = await response.text();
        sessionStorage.setItem(scriptKey, scriptText);

        // Inject script into the document
        const script = document.createElement("script");
        script.type = "text/javascript";
        script.text = scriptText;
        document.head.appendChild(script);
        console.log("Fetched aladin.js and saved to sessionStorage");
    }

    // Fetch the targets
    const targets = await fetchAladinTargets();
    const largeTargetsWarning = document.getElementById("aladin-target-warning");
    // Display a warning if there are too many targets to display on the map at once.
    if (targets.length >= 10000) {
      largeTargetsWarning.classList.remove("d-none");
    } else {
      largeTargetsWarning.classList.add("d-none");
    }

    // Initialize Aladin after script loads

    A.init.then(() => {
        window.aladin = A.aladin("#aladin-lite-div", {
            survey: "P/DSS2/color",
            fov: 360,
            projection: "MOL",
            showReticle: false,
            showCooGrid: true,
            showCooGridControl: true,
        });

        aladin.setCooGrid({ color: 'grey', labelSize: 10 });

        // define catalog for the targets
        var catalogOptions = {
            name: 'Targets',
            color: 'blue',
            sourceSize: 16};

        const targetCatalog = A.catalog({name: "Targets" , color: 'blue', sourceSize: 16});
        const markers = targets.map(target =>{
          const popupInfo = ['RA: '.concat(target.ra, '<br>',  'Dec: ', target.dec)];
          return A.marker(target.ra, target.dec, {popupTitle: target.name, popupDesc: popupInfo})
        });
        targetCatalog.addSources(markers);
        aladin.addCatalog(targetCatalog);

        // extract Moon information from the context
        const moonRaDeg = {{ moon_ra|safe }};
        const moonDecDeg = {{ moon_dec|safe }};
        const moonIllumination = {{ moon_illumination|safe }}.toFixed(3);
        const moonGreyscale = 255 * moonIllumination;

        // get a unicode representation of the Moon based on illumination fraction
        var unicodeMoon;
        if (moonIllumination <= 0.125 ) {
            unicodeMoon = "\uD83C\uDF11";
        } else if (moonIllumination <= 0.375) {
            unicodeMoon = "\uD83C\uDF12";
        } else if (moonIllumination <= 0.625) {
            unicodeMoon = "\uD83C\uDF13";
        } else if (moonIllumination <= 0.875) {
            unicodeMoon = "\uD83C\uDF14";
        } else if (moonIllumination <= 1.0) {
            unicodeMoon = "\uD83C\uDF15";
        }

        // Create a text based symbol for the moon centered on the source coordinates
        var drawMoon = function(source, canvasCtx) {
            canvasCtx.globalAlpha = 1;
            canvasCtx.font = '25px Arial';
            canvasCtx.fillStyle = '#eee';
            canvasCtx.textBaseline = 'middle';
            canvasCtx.textAlign = 'center';
            canvasCtx.fillText(unicodeMoon, source.x, source.y);
        };

        // create a catalog for the moon
        const moonImage = A.catalog({shape: drawMoon, color: 'gray', name: 'Moon'});

        const popupMoonDescription = `Illumination: ${moonIllumination} <br> RA: ${moonRaDeg.toFixed(4)} <br> Dec: ${moonDecDeg.toFixed(4)}`;

        moonImage.addSources([A.marker(moonRaDeg, moonDecDeg,
            {popupTitle: 'Moon (Geocentric)',
            popupDesc: popupMoonDescription,
            })]);

        aladin.addCatalog(moonImage);

        // now add the sun in its own catalog
        const sunCatalog = A.catalog({
            name: 'Sun',
            shape: 'circle',
            color: 'yellow',
            sourceSize: 30}); // fontSize from Moon canvas plus 5 to match sizes

        const sunRaDeg = {{ sun_ra|safe }};
        const sunDecDeg = {{ sun_dec|safe }};

        const popupSunDescription = `RA: ${sunRaDeg.toFixed(4)} <br> Dec: ${sunDecDeg.toFixed(4)}`;

        sunCatalog.addSources([A.marker(sunRaDeg, sunDecDeg,
            {popupTitle: 'Sun (Geocentric)',
            popupDesc: popupSunDescription,
            })]);

        aladin.addCatalog(sunCatalog);

    }); // closes A.init.then(() { ...

})();
</script>
